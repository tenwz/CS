# Redis

## 基础

- 性能

  - 单线程（网络 IO && 键值对读写）（10W）
    - 持久化、异步删除、集群数据同步（额外线程）
    - 多线程开销（并发控制问题）
    - 内存 && 良好的数据结构 && TODO：多路复用

- 日志

  - AOF
    - 写后日志（Redis 命令）
      - 优点
        - 避免额外检查开销
        - 不阻塞当前写操作
      - 风险
        - 数据丢失（写内存成功但未写日志）
        - 阻塞下一个操作（AOF日志在主线程中执行）
    - 写回策略（性能 && 丢数据 balance）
      - Always && EverySec && No（由操作系统决定）
    - 重写机制
      - 问题：
        - 文件系统大小限制
        - 文件过大，追加性能降低
        - 宕机恢复缓慢
      - 原理：扫库，生成对应写命令
      - 重写由 bgrewriteaof 线程完成（避免阻塞主线程）
        - “一个拷贝，两处日志”
        - 原 AOF 正常执行，新操作写入重写日志缓冲区，merge到新AOF，然后替换
  - RDB（全量快照）
    - AOF 记录操作命令而非实际数据，所以恢复较慢
    - save && bgsave（background）
    - COW （共享内存，谁改谁生成副本）
  - AOF日志和内存快照混合使用
    - AOF 记录两次快照中间操作
    - 第二次快照后清空中间 AOF 日志

- 数据结构

- 缓存

  - 穿透
  - 雪崩
  - 污染

- 分布式（服务少中断）读写分离

  - 问题：分批同步 or 一次性同步 && 网络断连 

    - replicaof ip port
      - psync 主库 RunId(第一次为 ？) offset（第一次为 -1）
      - FULLRESYNC 返回 RunID 和 offset （FULLRESYNC 表示第一次复制采用的全量复制）（主库这个过程不会阻塞）
      - 从库收到数据，在本地完成数据加载（依赖于RDB）（* 为了避免之前数据影响，会清空当前数据库）
      - 主库在内存中用 replication buffer 记录RDB文件生成后的所有写操作，当RDB发送完成，将buffer发送给从库
    - 网络断连 TODO：
      - 增量复制（repl_backlog_buffer（环形缓冲区）)
      - 断连后，断连期间的写操作命令写入replication buffer 同时也会写入到repl_backlog_buffer

  - 哨兵机制

    - 关注
      - 主库是否真的挂了
      - 选举哪个从库
      - 新主库信息如何同步到从库和客户端
    - 哨兵负责：监控，选主，通知
      - 监控：周期 PING（误判：哨兵集群少数服从多数 N/2 +1）
      - 切换：（筛选+打分）TODO：
      - 通知其他从库执行 replicaof 命令 && 通知客户端（请求打到新主库）
    - 哨兵通信TODO：

  - 切片集群

    - 关注：

      - 数据切片在多个实例的分布
      - 客户端如何确定访问的数据在哪个实例

    - 分布

      - Redis Cluster 采用 Hash Slot && 一个切片集群共有 16384 个哈希槽
        - 根据key 用CRC16 计算出 16bit值，对16384 取模，得到该编号的哈希槽（对应在一个机器下）
        - cluster create 命令创建集群，如果集群有N个实例，那么每个实例槽个数是 16384 / N
        - cluster meet  和 cluster addslots 手动指定每个实例哈希槽的个数

    - 定位

      - Redis 实例间会相互扩散哈希槽的映射关系，客户端收到哈希槽信息会将其缓存到本地

        - 问题：
          - 新增删除实例 && 负载均衡重新分布实例后
          - 客户端不知道更新的路由信息
        - 重定向机制：
          - 访问一个实例没有数据时，该实例会返回 MOVED 命令结果，将槽的最新位置信息返回给客户端
          - 客户端会再次发送请求，同时更新本地对应信息缓存
          - 如果 某个槽 正在实例之间迁移，客户端会向新实例发送ASKING命令。。。。。不会更新缓存

        

## 场景&应用

## 调优

- 关注 QPS

- 单线程阻塞