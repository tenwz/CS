# Redis

## 基础

- 性能
  - 单线程（网络 IO && 键值对读写）（10W）
    - 持久化、异步删除、集群数据同步（额外线程）
    - 多线程开销（并发控制问题）
    - 内存 && 良好的数据结构 && TODO：多路复用
- 日志
  - AOF
    - 写后日志（Redis 命令）
      - 优点
        - 避免额外检查开销
        - 不阻塞当前写操作
      - 风险
        - 数据丢失（写内存成功但未写日志）
        - 阻塞下一个操作（AOF日志在主线程中执行）
    - 写回策略（性能 && 丢数据 balance）
      - Always && EverySec && No（由操作系统决定）
    - 重写机制
      - 问题：
        - 文件系统大小限制
        - 文件过大，追加性能降低
        - 宕机恢复缓慢
      - 原理：扫库，生成对应写命令
      - 重写由 bgrewriteaof 线程完成（避免阻塞主线程）
        - “一个拷贝，两处日志”
        - 原 AOF 正常执行，新操作写入重写日志缓冲区，merge到新AOF，然后替换
  - RDB（全量快照）
    - AOF 记录操作命令而非实际数据，所以恢复较慢
    - save && bgsave（background）
    - COW （共享内存，谁改谁生成副本）
  - AOF日志和内存快照混合使用
    - AOF 记录两次快照中间操作
    - 第二次快照后清空中间 AOF 日志
- 数据结构
- 缓存
  - 穿透
  - 雪崩
  - 污染
- 分布式集群

## 场景&应用

## 调优

- 关注 QPS

- 单线程阻塞